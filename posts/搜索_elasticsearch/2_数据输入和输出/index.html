<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>2. 数据输入和输出 - </title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="2. 数据输入和输出" />
<meta property="og:description" content="一、 参考 elasticsearch权威指南 二、 概要 面向对象编程语言如此流行的原因之一是对象帮我们表示和处理现实世界具有潜在的复杂的数据结构的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yzthewind.github.io/posts/%E6%90%9C%E7%B4%A2_elasticsearch/2_%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA/" />
<meta property="og:image" content="https://yzthewind.github.io/logo.png"/>
<meta property="article:published_time" content="2020-07-01T11:00:00+08:00" />
<meta property="article:modified_time" content="2020-07-01T11:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://yzthewind.github.io/logo.png"/>

<meta name="twitter:title" content="2. 数据输入和输出"/>
<meta name="twitter:description" content="一、 参考 elasticsearch权威指南 二、 概要 面向对象编程语言如此流行的原因之一是对象帮我们表示和处理现实世界具有潜在的复杂的数据结构的"/>
<meta name="application-name" content="一曲广陵散">
<meta name="apple-mobile-web-app-title" content="一曲广陵散"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://yzthewind.github.io/posts/%E6%90%9C%E7%B4%A2_elasticsearch/2_%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA/" /><link rel="prev" href="https://yzthewind.github.io/posts/%E6%90%9C%E7%B4%A2_elasticsearch/1_%E9%9B%86%E7%BE%A4%E5%86%85%E7%9A%84%E5%8E%9F%E7%90%86/" /><link rel="next" href="https://yzthewind.github.io/posts/%E6%90%9C%E7%B4%A2_elasticsearch/3_%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "2. 数据输入和输出",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/yzthewind.github.io\/posts\/%E6%90%9C%E7%B4%A2_elasticsearch\/2_%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA\/"
        },"genre": "posts","keywords": "elasticsearch","wordcount":  5164 ,
        "url": "https:\/\/yzthewind.github.io\/posts\/%E6%90%9C%E7%B4%A2_elasticsearch\/2_%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA\/","datePublished": "2020-07-01T11:00:00+08:00","dateModified": "2020-07-01T11:00:00+08:00","publisher": {
            "@type": "Organization",
            "name": "yz"},"author": {
                "@type": "Person",
                "name": "yz"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title=""><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title=""><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">2. 数据输入和输出</h1><h2 class="single-subtitle">elasticsearch权威指南</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>yz</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%90%9C%E7%B4%A2/"><i class="far fa-folder fa-fw"></i>搜索</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-07-01">2020-07-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5164 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/elasticsearch/%e6%95%b0%e6%8d%ae%e8%be%93%e5%85%a5%e5%92%8c%e8%be%93%e5%87%ba.jpg"
        data-srcset="/images/elasticsearch/%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA.jpg, /images/elasticsearch/%e6%95%b0%e6%8d%ae%e8%be%93%e5%85%a5%e5%92%8c%e8%be%93%e5%87%ba.jpg 1.5x, /images/elasticsearch/%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA.jpg 2x"
        data-sizes="auto"
        alt="/images/elasticsearch/%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA.jpg"
        title="/images/elasticsearch/%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA.jpg" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一-参考">一、 参考</a></li>
    <li><a href="#二-概要">二、 概要</a>
      <ul>
        <li><a href="#21-json">2.1 json</a></li>
        <li><a href="#22-查询">2.2 查询</a></li>
      </ul>
    </li>
    <li><a href="#三-什么是文档">三、 什么是文档</a>
      <ul>
        <li><a href="#31-文档与对象">3.1 文档与对象</a></li>
        <li><a href="#32-文档元数据">3.2 文档元数据</a></li>
      </ul>
    </li>
    <li><a href="#四-文档的操作">四、 文档的操作</a>
      <ul>
        <li><a href="#41-索引文档">4.1 索引文档</a></li>
        <li><a href="#42-取回文档">4.2 取回文档</a></li>
        <li><a href="#43-检查文档是否存在">4.3 检查文档是否存在</a></li>
        <li><a href="#44-更新文档">4.4 更新文档</a></li>
        <li><a href="#45-创建新文档">4.5 创建新文档</a></li>
        <li><a href="#46-删除文档">4.6 删除文档</a></li>
        <li><a href="#47-处理冲突">4.7 处理冲突</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><hr>
<p> </p>
<h2 id="一-参考">一、 参考</h2>
<p> </p>
<blockquote>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" target="_blank" rel="noopener noreffer">elasticsearch权威指南</a></p>
</blockquote>
<hr>
<p> </p>
<h2 id="二-概要">二、 概要</h2>
<p> </p>
<p>面向对象编程语言如此流行的原因之一是对象帮我们表示和处理现实世界具有潜在的复杂的数据结构的实体，到目前为止，一切都很完美！</p>
<p>但是当我们需要存储这些实体时问题来了，传统上，我们以行和列的形式存储数据到关系型数据库中，相当于使用电子表格。 正因为我们使用了这种不灵活的存储媒介导致所有我们使用对象的灵活性都丢失了</p>
<p>但是否我们可以将我们的对象按对象的方式来存储？这样我们就能更加专注于 使用 数据，而不是在电子表格的局限性下对我们的应用建模。 我们可以重新利用对象的灵活性</p>
<p> </p>
<h3 id="21-json">2.1 json</h3>
<p> </p>
<p>一个 对象 是基于特定语言的内存的数据结构。为了通过网络发送或者存储它，我们需要将它表示成某种标准的格式。 <code>JSON</code> 是一种以人可读的文本表示对象的方法。 它已经变成 <code>NoSQL</code> 世界交换数据的事实标准。当一个对象被序列化成为 <code>JSON</code>，它被称为一个 <code>JSON</code> 文档</p>
<p><code>Elastcisearch</code> 是分布式的 文档 存储。它能存储和检索复杂的数据结构—​序列化成为<code>JSON</code>文档—​以 实时 的方式。 换句话说，一旦一个文档被存储在 <code>Elasticsearch</code> 中，它就是可以被集群中的任意节点检索到</p>
<p> </p>
<h3 id="22-查询">2.2 查询</h3>
<p> </p>
<p>当然，我们不仅要存储数据，我们一定还需要查询它，成批且快速的查询它们。 尽管现存的 <code>NoSQL</code> 解决方案允许我们以文档的形式存储对象，但是他们仍旧需要我们思考如何查询我们的数据，以及确定哪些字段需要被索引以加快数据检索</p>
<p>在 <code>Elasticsearch</code> 中， 每个字段的所有数据 都是 默认被索引的 。 即每个字段都有为了快速检索设置的专用倒排索引。而且，不像其他多数的数据库，它能在 同一个查询中 使用所有这些倒排索引，并以惊人的速度返回结果</p>
<hr>
<p> </p>
<h2 id="三-什么是文档">三、 什么是文档</h2>
<p> </p>
<p>在大多数应用中，多数实体或对象可以被序列化为包含键值对的 <code>JSON</code> 对象</p>
<p>一个 键 可以是一个字段或字段的名称,</p>
<p><code>⚠️</code>字段的名字可以是任何合法的字符串，但 不可以 包含英文句号<code>(.)</code></p>
<p>一个 值 可以是</p>
<p>(1) 一个字符串，</p>
<p>(2) 一个数字，</p>
<p>(3) 一个布尔值，</p>
<p>(4) 另一个对象，</p>
<p>(5) 一些数组值，</p>
<p>(6) 或一些其它特殊类型, 诸如表示日期的字符串，或代表一个地理位置的对象</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
 <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;John Smith&#34;</span><span class="p">,</span> <span class="err">//</span> <span class="err">(1)</span>
 <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="err">//</span> <span class="err">(2)</span>
 <span class="nt">&#34;confirmed&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="err">//</span> <span class="err">(3)</span>
 <span class="nt">&#34;join_date&#34;</span><span class="p">:</span> <span class="s2">&#34;2014-06-01&#34;</span><span class="p">,</span>  <span class="err">//</span> <span class="err">(6)</span>
 <span class="nt">&#34;home&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="err">//</span> <span class="err">(4)</span> <span class="err">(6)</span>
   <span class="nt">&#34;lat&#34;</span><span class="p">:</span> <span class="mf">51.5</span><span class="p">,</span>
   <span class="nt">&#34;lon&#34;</span><span class="p">:</span> <span class="mf">0.1</span>
 <span class="p">},</span>
 <span class="nt">&#34;accounts&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="err">//</span> <span class="err">(</span><span class="mi">5</span><span class="err">)</span>
   <span class="p">{</span>
     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;facebook&#34;</span><span class="p">,</span>
     <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;johnsmith&#34;</span>
   <span class="p">},</span>
   <span class="p">{</span>
     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;twitter&#34;</span><span class="p">,</span>
     <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;johnsmith&#34;</span>
   <span class="p">}</span>
 <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p> </p>
<h3 id="31-文档与对象">3.1 文档与对象</h3>
<p> </p>
<p>通常情况下，我们使用的术语 对象 和 文档 是可以互相替换的</p>
<p>不过，有一个区别： 一个对象仅仅是类似于 <code>hash</code> 、 <code>hashmap</code> 、字典或者关联数组的 <code>JSON</code> 对象，对象中也可以嵌套其他的对象。 对象可能包含了另外一些对象</p>
<p>在 <code>Elasticsearch </code>中，术语 文档 有着特定的含义。它是指最顶层或者根对象, 这个根对象被序列化成 <code>JSON</code> 并存储到 <code>Elasticsearch</code> 中，指定了唯一 <code>ID</code></p>
<p> </p>
<h3 id="32-文档元数据">3.2 文档元数据</h3>
<p> </p>
<p>一个文档不仅仅包含它的数据 ，也包含 元数据 —— 有关 文档的信息。 三个必须的元数据元素如下:</p>
<p>(1) <code>_index</code>, 文档在哪存放</p>
<p>(2) <code>_type</code>, 文档表示的对象类别</p>
<p>(3) <code>_id</code>, 文档唯一标识</p>
<p> </p>
<h4 id="321-_index">3.2.1 _index</h4>
<p> </p>
<p>一个 索引 应该是因共同的特性被分组到一起的文档集合</p>
<p>实际上，在 <code>Elasticsearch</code> 中，我们的数据是被存储和索引在 分片 中，而一个索引仅仅是逻辑上的命名空间, 这个命名空间由一个或者多个分片组合在一起</p>
<p>然而，这是一个内部细节，我们的应用程序根本不应该关心分片，对于应用程序而言，只需知道文档位于一个 索引 内。 <code>Elasticsearch</code> 会处理所有的细节</p>
<p>所有需要我们做的就是选择一个索引名，这个名字必须小写，不能以下划线开头，不能包含逗号</p>
<p> </p>
<h4 id="322-_type">3.2.2 _type</h4>
<p> </p>
<p>该参数将会被取消，新版本中默认只有一个<code>_type</code>, 值为 <code>_doc</code></p>
<p> </p>
<h4 id="323-_id">3.2.3 _id</h4>
<p> </p>
<p><code>ID</code> 是一个字符串，当它和 <code>_index</code> 以及 <code>_type</code> 组合就可以唯一确定 <code>Elasticsearch</code> 中的一个文档。 当你创建一个新的文档，要么提供自己的 <code>_id</code> ，要么让 <code>Elasticsearch</code> 帮你生成</p>
<hr>
<p> </p>
<h2 id="四-文档的操作">四、 文档的操作</h2>
<p> </p>
<p> </p>
<h3 id="41-索引文档">4.1 索引文档</h3>
<p> </p>
<p>通过使用 <code>index API</code> ，文档可以被 索引 —— 存储和使文档可被搜索。 但是首先，我们要确定文档的位置。正如我们刚刚讨论的，一个文档的<code> _index</code> 、 <code>_type</code> 和 <code>_id</code> 唯一标识一个文档。 我们可以提供自定义的 <code>_id</code> 值，或者让 <code>index API</code> 自动生成</p>
<p> </p>
<h4 id="411-使用自定义的id">4.1.1 使用自定义的id</h4>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">123</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span>  <span class="s2">&#34;Just trying this out...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span>  <span class="s2">&#34;2014/01/01&#34;</span>
<span class="p">}</span>

<span class="err">#</span> <span class="err">返回值</span>

<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p>在 <code>Elasticsearch</code> 中每个文档都有一个版本号。当每次对文档进行修改时（包括删除）， <code>_version</code> 的值会递增</p>
<p> </p>
<h4 id="412-es生成id">4.1.2 es生成id</h4>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">
<span class="err">POST</span> <span class="err">/website/_doc/</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span>  <span class="s2">&#34;Just trying this out...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span>  <span class="s2">&#34;2014/01/01&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;LXijInMBHZp3u4gbKsFY&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<p>如果数据没有自然的 <code>ID</code>， <code>Elasticsearch</code> 可以帮我们自动生成 <code>ID</code> 。</p>
<p>请求的结构调整为：</p>
<p>(1) 不再使用 <code>PUT</code> 谓词(“使用这个 <code>URL</code> 存储这个文档”)，</p>
<p>而是使用 <code>POST</code> 谓词(“存储文档在这个 <code>URL</code> 命名空间下”)</p>
<p>(2) 该 <code>URL</code> 只需包含 <code>_index</code> 和 <code>_type</code></p>
<p> </p>
<p>自动生成的 <code>ID</code> 是 <code>URL-safe</code>、 基于 <code>Base64</code> 编码且长度为<code>20</code>个字符的 <code>GUID</code> 字符串。</p>
<p>这些 <code>GUID</code> 字符串由可修改的 <code>FlakeID</code> 模式生成，这种模式允许多个节点并行生成唯一 <code>ID</code> ，且互相之间的冲突概率几乎为零</p>
<p> </p>
<h3 id="42-取回文档">4.2 取回文档</h3>
<p> </p>
<p> </p>
<h4 id="421-取回文档全部内容">4.2.1 取回文档全部内容</h4>
<p> </p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/website/_doc/</span><span class="mi">123</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;found&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
    <span class="nt">&#34;text&#34;</span> <span class="p">:</span> <span class="s2">&#34;Just trying this out...&#34;</span><span class="p">,</span>
    <span class="nt">&#34;date&#34;</span> <span class="p">:</span> <span class="s2">&#34;2014/01/01&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p>取回文档的请求如上：</p>
<p>(1) <code>HTTP</code> 谓词更改为 <code>GET</code>;</p>
<p>(2) <code>uri</code>中包含相同的 <code>_index</code> , <code>_type</code> , 和 <code>_id</code></p>
<p>(3) <code>GET</code> 请求的响应体包括 <code>{&quot;found&quot;: true} </code>，这证实了文档已经被找到</p>
<p>如果请求一个不存在的文档，仍旧会得到一个 <code>JSON</code> 响应体，但是 <code>found</code> 将会是 <code>false</code></p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/website/_doc/</span><span class="mi">1234</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1234&#34;</span><span class="p">,</span>
  <span class="nt">&#34;found&#34;</span> <span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<p> </p>
<h4 id="422-返回部分文档">4.2.2 返回部分文档</h4>
<p> </p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/website/_doc/</span><span class="mi">123</span><span class="err">/_source</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span> <span class="p">:</span> <span class="s2">&#34;Just trying this out...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span> <span class="p">:</span> <span class="s2">&#34;2014/01/01&#34;</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p>(1) 如果你只想得到 <code>_source</code> 字段，不需要任何元数据，你能使用 <code>_source</code> 端点</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/website/_doc/</span><span class="mi">123</span><span class="err">?_source=title,date</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;found&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;date&#34;</span> <span class="p">:</span> <span class="s2">&#34;2014/01/01&#34;</span><span class="p">,</span>
    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>


</code></pre></div><p> </p>
<p>(2) 默认情况下， <code>GET</code> 请求会返回整个文档，这个文档正如存储在 <code>_source</code> 字段中的一样。</p>
<p>但是也许你只对其中的 <code>title</code> 字段感兴趣。单个字段能用<code> _source</code> 参数请求得到，多个字段也能使用<code>逗号分隔</code>的列表来指定</p>
<p> </p>
<h3 id="43-检查文档是否存在">4.3 检查文档是否存在</h3>
<p> </p>
<p>问：如果只想检查一个文档是否存在, 根本不想关心内容?</p>
<p>​答：可以使用 <code>HEAD</code> 方法来代替 <code>GET</code> 方法。</p>
<p><code>HEAD</code> 请求没有返回体，只返回一个 <code>HTTP</code> 请求报头</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">HEAD</span> <span class="err">website/_doc/</span><span class="mi">123</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="mi">200</span> <span class="err">-</span> <span class="err">OK</span>

<span class="err">HEAD</span> <span class="err">website/_doc/</span><span class="mi">1234</span>

<span class="err">//返回值</span>
<span class="mi">404</span> <span class="err">-</span> <span class="err">Not</span> <span class="err">Found</span>

</code></pre></div><p> </p>
<p>一个文档仅仅是在检查的时候不存在，并不意味着1毫秒之后它也不存在：也许同时正好另一个进程就创建了该文档</p>
<p> </p>
<h3 id="44-更新文档">4.4 更新文档</h3>
<p> </p>
<p> </p>
<h4 id="441-更新整个文档">4.4.1 更新整个文档</h4>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">123</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;I am starting to get the hang of this...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2014/01/02&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>

<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;updated&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>


</code></pre></div><p> </p>
<p>更新整个文档，和索引文档一样，需要</p>
<p>(1) 使用<code>PUT</code>方法</p>
<p>(2) <code>uri</code>中包含<code>_index</code>, <code>_type</code>, <code>_id</code></p>
<p>从响应体可以得到：</p>
<p>(1) <code>Elasticsearch</code> 已经增加了 <code>_version</code> 字段值</p>
<p>(2) <code>result</code>值为<code>updated</code>, 而初次创建时候，值为<code>created</code></p>
<p> </p>
<p>更新的内部原理：</p>
<p>在内部，<code>Elasticsearch</code> 已将旧文档标记为已删除，并增加一个全新的文档</p>
<p>尽管你不能再对旧版本的文档进行访问，但它并不会立即消失</p>
<p>当继续索引更多的数据，<code>Elasticsearch</code> 会在后台清理这些已删除文档</p>
<p> </p>
<p>内部实际过程如下：</p>
<p>(1) 从旧文档构建 <code>JSON</code>;</p>
<p>(2) 更改该 <code>JSON</code></p>
<p>(3) 删除旧文档</p>
<p>(4) 索引一个新文档</p>
<p> </p>
<h4 id="442-部分更新文档">4.4.2 部分更新文档</h4>
<p> </p>
<p>使用 <code>update API</code> 可以部分更新文档</p>
<p> </p>
<p>更新的原理：</p>
<p>文档不能被修改，只能被替换, <code>update API</code> 必须遵循同样的规则</p>
<p>(1) 从外部来看，我们在一个文档的某个位置进行部分更新</p>
<p>然而在内部， <code>update API</code> 简单使用与之前描述相同的 检索-修改-重建索引 的处理过程</p>
<p>(2) 区别在于这个过程发生在分片内部，这样就避免了多次请求的网络开销</p>
<p>通过减少检索和重建索引步骤之间的时间，我们也减少了其他进程的变更带来冲突的可能性</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">
<span class="err">//</span> <span class="err">（</span><span class="mi">1</span><span class="err">）原有数据</span>

<span class="err">GET</span> <span class="err">website/_search</span>
<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;took&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;timed_out&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&#34;relation&#34;</span> <span class="p">:</span> <span class="s2">&#34;eq&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
          <span class="nt">&#34;text&#34;</span> <span class="p">:</span> <span class="s2">&#34;Starting to get the hang of this...&#34;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//（</span><span class="mi">2</span><span class="err">）更新</span>
<span class="err">POST</span> <span class="err">/website/_doc/</span><span class="mi">1</span><span class="err">/_update</span>
<span class="p">{</span>
  <span class="nt">&#34;doc&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&#34;testing&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;views&#34;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">或者</span>

<span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;doc&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&#34;testing&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;views&#34;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>

<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;noop&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<p>(1) <code>update</code> 请求最简单的一种形式是接收文档的一部分作为 <code>doc</code> 的参数，
它只是与现有的文档进行合并。对象被合并到一起，覆盖现有的字段，增加新的字段</p>
<p>(2) 脚本可以在 <code>update API</code>中用来改变 <code>_source</code> 的字段内容， 它在更新脚本中称为 <code>ctx._source</code></p>
<p>对于那些 <code>API</code> 不能满足需求的情况，<code>Elasticsearch</code> 允许你使用脚本编写自定义的逻辑。</p>
<p>许多<code>API</code>都支持脚本的使用，包括搜索、排序、聚合和文档更新</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">
<span class="err">//</span> <span class="err">(</span><span class="mi">1</span><span class="err">)</span> <span class="err">更新数值型字段值</span>
<span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx._source.views+=1&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>

<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;updated&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">（</span><span class="mi">2</span><span class="err">）</span> <span class="err">更新数值值</span>
<span class="err">POST</span> <span class="err">website/_update/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx._source.tags.add(params.new_tag)&#34;</span><span class="p">,</span>
    <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;new_tag&#34;</span><span class="p">:</span> <span class="s2">&#34;search&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;updated&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">(</span><span class="mi">3</span><span class="err">)</span> <span class="err">删除文档</span>
<span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx.op = ctx._source.views == params.count ? &#39;delete&#39; : &#39;none&#39;&#34;</span><span class="p">,</span>
    <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;deleted&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>


</code></pre></div><p> </p>
<p>(3) 如果我们尝试更新一个不存在的文档，那么更新操作将会失败,
在这样的情况下，我们可以使用 <code>upsert</code> 参数，指定如果文档不存在就应该先创建它</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">(</span><span class="mi">1</span><span class="err">)</span> <span class="err">不存在文档</span>
<span class="err">GET</span> <span class="err">website/_search</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;took&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;timed_out&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">&#34;relation&#34;</span> <span class="p">:</span> <span class="s2">&#34;eq&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">（</span><span class="mi">2</span><span class="err">）第一次更新，文档不存在，即执行创建</span>
<span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">3</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx._source.views+=1&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;upsert&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;views&#34;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">（</span><span class="mi">3</span><span class="err">）文档存在，更新文档字段</span>
<span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">3</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx._source.views+=1&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;upsert&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;views&#34;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;updated&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">（</span><span class="mi">4</span><span class="err">）更新后的文档信息</span>
<span class="err">GET</span> <span class="err">website/_search</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;took&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nt">&#34;timed_out&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;value&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&#34;relation&#34;</span> <span class="p">:</span> <span class="s2">&#34;eq&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
        <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;views&#34;</span> <span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>



</code></pre></div><p> </p>
<p>(4) 如果两个进程都对页面访问量计数器进行递增操作，它们发生的先后顺序其实不太重要；</p>
<p>如果冲突发生了，我们唯一需要做的就是尝试再次更新</p>
<p>可以通过设置参数 <code>retry_on_conflict</code> 来自动完成， 这个参数规定了失败之前 <code>update</code> 应该重试的次数，它的默认值为 <code>0</code></p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">POST</span> <span class="err">/website/_update/</span><span class="mi">3</span><span class="err">?retry_on_conflict=</span><span class="mi">5</span>
<span class="p">{</span>
  <span class="nt">&#34;script&#34;</span><span class="p">:</span> <span class="s2">&#34;ctx._source.views+=1&#34;</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<p>(5) <code>update API</code> 默认采用 最终写入生效 的方案</p>
<p> </p>
<h3 id="45-创建新文档">4.5 创建新文档</h3>
<p> </p>
<p>问： 当索引一个文档，怎么确认我们正在创建一个完全新的文档，而不是覆盖现有的呢？</p>
<p> </p>
<h4 id="451-es自生成id">4.5.1 ES自生成ID</h4>
<p> </p>
<p><code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 的组合可以唯一标识一个文档</p>
<p>所以， 确保创建一个新文档的最简单办法是，</p>
<p>使用索引请求的 <code>POST</code> 形式让 <code>Elasticsearch</code> 自动生成唯一 <code>_id</code></p>
<p> </p>
<h4 id="452-文档中存在id">4.5.2 文档中存在ID</h4>
<p> </p>
<p>如果已经有自己的<code> _id</code>, 那么必须告诉 <code>Elasticsearch</code> ，只有在相同的 <code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 不存在时才接受索引请求</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">
<span class="err">//</span> <span class="err">(</span><span class="mi">1</span><span class="err">)</span> <span class="err">使用</span> <span class="err">_create</span>

<span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">123</span><span class="err">/_create</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;I am starting to get the hang of this...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2014/01/02&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">(</span><span class="mi">2</span><span class="err">)</span> <span class="err">使用op_type参数</span>

<span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">124</span><span class="err">?op_type=create</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;I am starting to get the hang of this...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2014/01/02&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<p>(1) 如果创建新文档的请求成功执行，<code>Elasticsearch</code> 会返回元数据和一个 <code>201 Created</code> 的 <code>HTTP</code> 响应码</p>
<p>(2) 另一方面，如果具有相同的 <code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 的文档已经存在，
<code>Elasticsearch</code> 将会返回<code> 409 Conflict</code> 响应码，以及如下的错误信息</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">123</span><span class="err">/_create</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;I am starting to get the hang of this...&#34;</span><span class="p">,</span>
  <span class="nt">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2014/01/02&#34;</span>
<span class="p">}</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;root_cause&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;version_conflict_engine_exception&#34;</span><span class="p">,</span>
        <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;[123]: version conflict, document already exists (current version [1])&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;kzyCDat7QLWnN7FeopsLlw&#34;</span><span class="p">,</span>
        <span class="nt">&#34;shard&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="s2">&#34;website&#34;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;version_conflict_engine_exception&#34;</span><span class="p">,</span>
    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;[123]: version conflict, document already exists (current version [1])&#34;</span><span class="p">,</span>
    <span class="nt">&#34;index_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;kzyCDat7QLWnN7FeopsLlw&#34;</span><span class="p">,</span>
    <span class="nt">&#34;shard&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
    <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="s2">&#34;website&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">409</span>
<span class="p">}</span>

</code></pre></div><p> </p>
<h3 id="46-删除文档">4.6 删除文档</h3>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">DELETE</span> <span class="err">/website/_doc/</span><span class="mi">123</span>

<span class="err">//</span> <span class="err">返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;deleted&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p>(1) 如果找到该文档，<code>Elasticsearch</code> 将要返回一个 <code>200 ok</code> 的 <code>HTTP</code> 响应码， <code>result</code>值为<code>deleted</code></p>
<p>(2) 如果文档没有找到，将得到 <code>404 Not Found</code> 的响应码和类似这样的响应体, <code>result</code>值为<code>not_found</code></p>
<p>(3) 不管文档是否存在，<code>_version</code> 值仍然会增加，这是 <code>Elasticsearch</code> 内部记录本的一部分，用来确保这些改变在跨多节点时以正确的顺序执行</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">DELETE</span> <span class="err">/website/_doc/</span><span class="mi">123</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;not_found&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div><p> </p>
<p> </p>
<h3 id="47-处理冲突">4.7 处理冲突</h3>
<p> </p>
<p>场景：</p>
<p>如果使用 <code>Elasticsearch</code> 存储我们网上商城商品库存的数量，</p>
<p>每次我们卖一个商品的时候，我们在 <code>Elasticsearch</code> 中将库存数量减少，</p>
<p>有一天，管理层决定做一次促销。突然地，我们一秒要卖好几个商品。</p>
<p>假设有两个 <code>web</code> 程序并行运行，每一个都同时处理所有商品的销售。</p>
<p><code>web_1</code> 对 <code>stock_count</code> 所做的更改已经丢失，</p>
<p>因为 <code>web_2 </code>不知道它的 <code>stock_count</code> 的拷贝已经过期，</p>
<p>结果我们会认为有超过商品的实际数量的库存，因为卖给顾客的库存商品并不存在，我们将让他们非常失望</p>
<p> </p>
<h4 id="471-悲观并发控制">4.7.1 悲观并发控制</h4>
<p> </p>
<p>这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。</p>
<p>一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改</p>
<p> </p>
<h4 id="472-乐观并发控制">4.7.2 乐观并发控制</h4>
<p> </p>
<p><code>Elasticsearch</code> 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。</p>
<p>然而，如果源数据在读写当中被修改，更新将会失败。</p>
<p>应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户</p>
<p> </p>
<p>问:</p>
<p><code>Elasticsearch</code> 是分布式的。当文档创建、更新或删除时， 新版本的文档必须复制到集群中的其他节点</p>
<p><code>Elasticsearch</code> 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许 顺序是乱的</p>
<p><code>Elasticsearch</code> 如何确保文档的旧版本不会覆盖新的版本？</p>
<p>老版本的回答：</p>
<p>可以利用 <code>_version</code> 号来确保 应用中相互冲突的变更不会导致数据丢失</p>
<p>(1) 每个文档都有一个 <code>_version</code> （版本）号，当文档被修改时版本号递增</p>
<p>(2) 如果旧版本的文档在新版本之后到达，它可以被简单的忽略</p>
<p>(3) 通过指定想要修改文档的 <code>version</code> 号来达到这个目的， 如果请求中版本不是当前版本号，请求将会失败</p>
<p> </p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">(</span><span class="mi">1</span><span class="err">)</span> <span class="err">创建文档</span>
<span class="err">PUT</span> <span class="err">/website/_doc/</span><span class="mi">1</span><span class="err">/_create</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;My first blog entry&#34;</span><span class="p">,</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;Just trying this out...&#34;</span>
<span class="p">}</span>

<span class="err">//返回值</span>
<span class="p">{</span>
  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;website&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;_doc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>










</code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-07-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/elasticsearch/">elasticsearch</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E6%90%9C%E7%B4%A2_elasticsearch/1_%E9%9B%86%E7%BE%A4%E5%86%85%E7%9A%84%E5%8E%9F%E7%90%86/" class="prev" rel="prev" title="1. 集群内的原理"><i class="fas fa-angle-left fa-fw"></i>1. 集群内的原理</a>
            <a href="/posts/%E6%90%9C%E7%B4%A2_elasticsearch/3_%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" class="next" rel="next" title="3. 乐观并发控制">3. 乐观并发控制<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">yz</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["yzthewind"],"clientID":"8e70465ecd960275a174","clientSecret":"32c54e1095f64e2ac3dcfa4afed2e61d5444bc0d","id":"2020-07-01T11:00:00+08:00","owner":"yzthewind","repo":"blog_gitalk","title":"2. 数据输入和输出"}},"data":{"id-1":"一曲广陵散","id-2":"一曲广陵散"},"typeit":{"cursorChar":null,"cursorSpeed":null,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":null,"speed":null}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
